services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: power-atlas-backend
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: ${NEO4J_USERNAME:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?Set NEO4J_PASSWORD in .env}
    # depends_on neo4j is preparatory: backend will connect to Neo4j once graph integration is implemented.
    depends_on:
      neo4j:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: power-atlas-frontend
    environment:
      # Public URL used by browser-based (client-side) code when accessing the backend from the host
      # This must be http://localhost:8000 because the requests are made from the user's browser,
      # not from within the container. If server-side requests are needed in the future,
      # add BACKEND_INTERNAL_URL: http://backend:8000 for container-to-container communication.
      NEXT_PUBLIC_BACKEND_URL: http://localhost:8000
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy

  neo4j:
    # Neo4j version is pinned for reproducible builds and to ensure compatibility with the
    # graph-data-science plugin. When upgrading, verify GDS support for the new Neo4j version.
    image: neo4j:5.22.0
    container_name: power-atlas-neo4j
    environment:
      NEO4J_AUTH: ${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:?Set NEO4J_PASSWORD in .env}
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_ACCEPT_LICENSE_AGREEMENT: ${NEO4J_ACCEPT_LICENSE_AGREEMENT:?Set NEO4J_ACCEPT_LICENSE_AGREEMENT (e.g. 'yes') in .env after reviewing Neo4j and GDS license terms}
      # Loosen procedure restrictions (unrestrict); set to gds.* only for local development experiments.
      NEO4J_dbms_security_procedures_unrestricted: ${NEO4J_UNRESTRICTED_PROCS:-gds.*}
    healthcheck:
      test:
        - CMD-SHELL
        - wget --spider --quiet http://localhost:7474 || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    ports:
      # Bind to loopback by default to keep Neo4j local-only. To expose externally, change to 0.0.0.0 or remove host IP.
      - "127.0.0.1:7474:7474"
      - "127.0.0.1:7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
